# 2DC 集群部署

## 部署环境

> 需求描述

部署环境总共四台机器, 两各机器在西安站内, 两各机器在广州站内, 站内主机互为主备, 西安站与广州站为主备。站内当一台机器挂机器, 另一台机器自动处理业务, 当西安主站失效, 广州主站处理业务。

当西安站主正常, 其他三台异常也能正常处理业务。

- 192.168.10.245   西安主
- 192.168.10.246   西安备
- 192.168.10.247   广州主
- 192.168.10.248   广州备

> 部署安装

1. 西安主 192.168.10.245

./bin/post_install.sh

nohup ./bin/yb-master \
  --master_addresses 192.168.10.245:7100 \
  --rpc_bind_addresses 192.168.10.245:7100 \
  --fs_data_dirs "/home/ykdl/db/disk1,/home/ykdl/db/disk2" \
  --replication_factor=1 \
  --placement_cloud ykdl \
  --placement_region zh-xa \
  --placement_zone zh-xa-1a \
  >& /home/ykdl/db/yb-master.out &

nohup ./bin/yb-tserver \
  --tserver_master_addrs 192.168.10.245:7100 \
  --rpc_bind_addresses 192.168.10.245:9100 \
  --pgsql_proxy_bind_address 192.168.10.245:5433 \
  --cql_proxy_bind_address 192.168.10.245:9042 \
  --fs_data_dirs "/home/ykdl/db/disk1,/home/ykdl/db/disk2" \
  --start_pgsql_proxy \
  --placement_cloud ykdl \
  --placement_region zh-xa \
  --placement_zone zh-xa-1a \
  >& /home/ykdl/db/yb-tserver.out &


<!-- ./bin/yugabyted start --base_dir=/home/ykdl/db/data --listen=192.168.10.248 --ui=true --master_flags="placement_cloud=ykdl placement_region=zh-xa placement_zone=zh-xa-1a" --tserver_flags="placement_cloud=ykdl placement_region=zh-xa placement_zone=zh-xa-1a"  -->


- 从西安从复制

./bin/yb-admin \
  -master_addresses 192.168.10.245:7100 \
  setup_universe_replication c497dcc7-48de-40f8-93a7-b884a91ae064 192.168.10.246:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

- 从广州主复制

./bin/yb-admin \
  -master_addresses 192.168.10.245:7100 \
  setup_universe_replication 65dbbafe-119b-40ea-b9e0-c8ff5dc8a192 192.168.10.247:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

- 从广州备复制

./bin/yb-admin \
  -master_addresses 192.168.10.245:7100 \
  setup_universe_replication f9b007ca-a489-4d51-bc3b-d964acb7215e 192.168.10.248:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

2. 西安备 192.168.10.246

./bin/post_install.sh

nohup ./bin/yb-master \
  --master_addresses 192.168.10.246:7100 \
  --rpc_bind_addresses 192.168.10.246:7100 \
  --fs_data_dirs "/home/ykdl/db/disk1,/home/ykdl/db/disk2" \
  --replication_factor=1 \
  --placement_cloud ykdl \
  --placement_region zh-xa \
  --placement_zone zh-xa-2a \
  >& /home/ykdl/db/yb-master.out &

nohup ./bin/yb-tserver \
  --tserver_master_addrs 192.168.10.246:7100 \
  --rpc_bind_addresses 192.168.10.246:9100 \
  --pgsql_proxy_bind_address 192.168.10.246:5433 \
  --cql_proxy_bind_address 192.168.10.246:9042 \
  --fs_data_dirs "/home/ykdl/db/disk1,/home/ykdl/db/disk2" \
  --placement_cloud ykdl \
  --placement_region zh-xa \
  --placement_zone zh-xa-2a \
  >& /home/ykdl/db/yb-tserver.out &

- 从西安主复制

./bin/yb-admin \
  -master_addresses 192.168.10.246:7100 \
  setup_universe_replication a68ef781-342e-4bad-a786-5cdbaa0350a5 192.168.10.245:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

- 从广州主复制

./bin/yb-admin \
  -master_addresses 192.168.10.246:7100 \
  setup_universe_replication 65dbbafe-119b-40ea-b9e0-c8ff5dc8a192 192.168.10.247:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

- 从广州备复制

./bin/yb-admin \
  -master_addresses 192.168.10.246:7100 \
  setup_universe_replication f9b007ca-a489-4d51-bc3b-d964acb7215e 192.168.10.248:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

3. 广州主 192.168.10.247

./bin/post_install.sh

nohup ./bin/yb-master \
  --master_addresses 192.168.10.247:7100 \
  --rpc_bind_addresses 192.168.10.247:7100 \
  --fs_data_dirs "/home/ykdl/db/disk1,/home/ykdl/db/disk2" \
  --replication_factor=1 \
  --placement_cloud ykdl \
  --placement_region zh-gz \
  --placement_zone zh-gz-1a \
  >& /home/ykdl/db/yb-master.out &

nohup ./bin/yb-tserver \
  --tserver_master_addrs 192.168.10.247:7100 \
  --rpc_bind_addresses 192.168.10.247:9100 \
  --pgsql_proxy_bind_address 192.168.10.247:5433 \
  --cql_proxy_bind_address 192.168.10.247:9042 \
  --fs_data_dirs "/home/ykdl/db/disk1,/home/ykdl/db/disk2" \
  --placement_cloud ykdl \
  --placement_region zh-gz \
  --placement_zone zh-gz-1a \
  >& /home/ykdl/db/yb-tserver.out &

- 从西安主复制

./bin/yb-admin \
  -master_addresses 192.168.10.247:7100 \
  setup_universe_replication a68ef781-342e-4bad-a786-5cdbaa0350a5 192.168.10.245:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

- 从西安从复制

./bin/yb-admin \
  -master_addresses 192.168.10.247:7100 \
  setup_universe_replication c497dcc7-48de-40f8-93a7-b884a91ae064 192.168.10.246:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

- 从广州备复制

./bin/yb-admin \
  -master_addresses 192.168.10.247:7100 \
  setup_universe_replication f9b007ca-a489-4d51-bc3b-d964acb7215e 192.168.10.248:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

4. 广州备 192.168.10.248

./bin/post_install.sh

nohup ./bin/yb-master \
  --master_addresses 192.168.10.248:7100 \
  --rpc_bind_addresses 192.168.10.248:7100 \
  --fs_data_dirs "/home/ykdl/db/disk1,/home/ykdl/db/disk2" \
  --replication_factor=1 \
  --placement_cloud ykdl \
  --placement_region zh-gz \
  --placement_zone zh-gz-1b \
  >& /home/ykdl/db/yb-master.out &

nohup /root/yugabyte-2.9.1.0/bin/yb-master --flagfile /home/ykdl/conf/master.conf >& /home/ykdl/db/yb-master.out &

```ini master.conf
--master_addresses=192.168.10.248:7100
--rpc_bind_addresses=192.168.10.248:7100
--fs_data_dirs=/home/ykdl/db/disk1,/home/ykdl/db/disk2
--replication_factor=1
--placement_cloud=ykdl 
--placement_region=zh-gz
--placement_zone=zh-gz-1b
```

nohup ./bin/yb-tserver \
  --tserver_master_addrs 192.168.10.248:7100 \
  --rpc_bind_addresses 192.168.10.248:9100 \
  --pgsql_proxy_bind_address 192.168.10.248:5433 \
  --cql_proxy_bind_address 192.168.10.248:9042 \
  --fs_data_dirs "/home/ykdl/db/disk1,/home/ykdl/db/disk2" \
  --placement_cloud ykdl \
  --placement_region zh-gz \
  --placement_zone zh-gz-1b \
  >& /home/ykdl/db/yb-tserver.out 2> /home/ykdl/db/yb-tserver.error &

nohup /root/yugabyte-2.9.1.0/bin/yb-tserver --flagfile /home/ykdl/conf/tserver.conf >& /home/ykdl/db/yb-tserver.out &

```ini tserver.conf
--tserver_master_addrs=192.168.10.248:7100
--rpc_bind_addresses=192.168.10.248:9100
--pgsql_proxy_bind_address=192.168.10.248:5433
--cql_proxy_bind_address=192.168.10.248:9042
--fs_data_dirs=/home/ykdl/db/disk1,/home/ykdl/db/disk2
--placement_cloud=ykdl
--placement_region=zh-gz
--placement_zone-zh-gz-1b
--start_pgsql_proxy
```

- 从西安主复制

./bin/yb-admin \
  -master_addresses 192.168.10.248:7100 \
  setup_universe_replication a68ef781-342e-4bad-a786-5cdbaa0350a5 192.168.10.245:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

- 从西安从复制

./bin/yb-admin \
  -master_addresses 192.168.10.248:7100 \
  setup_universe_replication c497dcc7-48de-40f8-93a7-b884a91ae064 192.168.10.246:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

- 从广州主复制

./bin/yb-admin \
  -master_addresses 192.168.10.248:7100 \
  setup_universe_replication 65dbbafe-119b-40ea-b9e0-c8ff5dc8a192 192.168.10.247:7100 \
    00004001000030008000000000004002,0000400100003000800000000000400e,00004001000030008000000000004018,00004001000030008000000000004025,00004001000030008000000000004030,0000400100003000800000000000403e,00004001000030008000000000004052,00004001000030008000000000004060,0000400100003000800000000000406a,00004001000030008000000000004073,00004001000030008000000000004078,00004001000030008000000000004083,00004001000030008000000000004092,0000400100003000800000000000409c,000040010000300080000000000040a5

> 界面

[](http://192.168.10.245:7000/)
[](http://192.168.10.245:9000/)

[](http://192.168.10.246:7000/)
[](http://192.168.10.246:9000/)

[](http://192.168.10.247:7000/)
[](http://192.168.10.247:9000/)

[](http://192.168.10.248:7000/)
[](http://192.168.10.248:9000/)

- 清理

rm -rf /home/ykdl/db/disk* /home/ykdl/db/*.out
mkdir -p /home/ykdl/db


## 创建数据库并新建表

1. 登录

./bin/ysqlsh -h 192.168.10.245 -p 5433
./bin/ysqlsh -h 192.168.10.245 -p 5433 -U syscontrol -d syscontrol

2. 新建用户

CREATE USER syscontrol WITH PASSWORD '123456';

3. 创建数据库

CREATE DATABASE syscontrol;

GRANT ALL ON DATABASE syscontrol to syscontrol; # 将数据库权限复制给用户

\c 查看当前连接信息
\l 列出所有数据库

\d 列出当前数据库所有表

4. 创建表 (所有区域表设置同步复制前, 需要先创建表结构; 对主键冲突的数据未进行同步)

CREATE TABLE OPR_LOG  (
    id bigint NOT NULL,
    ykdl_id int NOT NULL DEFAULT 0,
    type int NOT NULL DEFAULT 0,
    opr_user_id varchar(500) NOT NULL DEFAULT '',
    opr_result_rmk varchar(255) NOT NULL DEFAULT '',
    opr_res smallint NOT NULL DEFAULT 0,
    create_time timestamp(0) NOT NULL,
    PRIMARY KEY (id)
);

INSERT INTO OPR_LOG ( id, ykdl_id, type, opr_user_id, opr_result_rmk, opr_res, create_time ) VALUES (1, 245, 7, 'root', '', 1, '2021-10-13 11:27:01');


## 单向复制配置

### 使用 setup_universe_replication

./bin/yb-admin \
  -master_addresses <consumer_universe_master_addresses> \
  setup_universe_replication <producer_universe_uuid> \
    <producer_universe_master_addresses> \
    <table_id>,[<table_id>..]

- master-addresses                  : 消费者的 YB-Master 主机和端口的逗号分隔列表。默认值为localhost:7100。
- producer_universe_uuid            ：生产者 Universe 的 UUID。
- producer_master_addresses         ：主生产者地址的逗号分隔列表。
- comma_separated_list_of_table_ids ：表标识符 ( table_id) 的逗号分隔列表。

./bin/yb-admin \
  -master_addresses 192.168.10.246:7100 \
  setup_universe_replication d3253aed-138a-4189-9c63-eda8d174d1e3 192.168.10.245:7100 \
    00004001000030008000000000004002

- 查看UUID

http://192.168.10.245:7000/cluster-config

- 查看所有表标识

./bin/yb-admin -master_addresses 192.168.10.245:7100 list_tables include_table_id


### 使用 alter_universe_replication 修改

yb-admin -master_addresses <master-addresses> \
    alter_universe_replication <producer_universe_uuid> \
    remove_table <table_id>[, <table_id>...]

- master-addresses          : YB-Master 主机和端口的逗号分隔列表。默认值为localhost:7100。
- producer_universe_uuid    ：生产者 Universe 的 UUID。
- table_id                  ：表的标识符 (ID)

./bin/yb-admin \
  -master_addresses 192.168.10.246:7100 \
  alter_universe_replication d3253aed-138a-4189-9c63-eda8d174d1e3 \
  remove_table 00004001000030008000000000004002

./bin/yb-admin \
  -master_addresses 192.168.10.246:7100 \
  alter_universe_replication d3253aed-138a-4189-9c63-eda8d174d1e3 \
  add_table 00004001000030008000000000004016



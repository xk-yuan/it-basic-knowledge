# IP

> IP 数据报

## 简介

IP报文是在网络层传输的数据单元，也叫IP数据报。

![](https://img-blog.csdn.net/20170301092349308)
![](https://img-blog.csdn.net/20170618100059739)
![](http://hi.csdn.net/attachment/201007/15/5573582_1279195143KN73.png)
![](https://img-blog.csdnimg.cn/20200406194818884.png)
![](https://pic2.zhimg.com/80/v2-b862f3280c0c4720ff6875133cbb7655_720w.jpg)

IP报文 = 版本 + 首部长度 + 区分服务 + 总长度   + 标识 + 标志 + 片偏移   + 生存时间 + 协议 + 首部校验和   + 源地址 + 目的地址 + 可选字段(长度可变) + 填充 + 数据部分

  : (4B) = 版本(4位) + 首部长度(4位) + 区分服务(1B) + 总长度(2B)
  : (4B) = 标识(2B) + 标志(3位) + 片偏移(5位 + 1B)
  : (4B) = 生存时间(1B) + 协议(1B) + 首部校验和(2B)
  : (4B) = 源地址
  : (4B) = 目的地址
  : (4B) = 可选字段(长度可变) + 填充
  : 数据

1. 版本 (4位)

  IP协议的版本，目前的IP协议版本号为4，下一代IP协议版本号为6。

2. 首部长度 (4位)

  IP报头的长度。固定部分的长度（20字节）和 可变部分的长度之和。共占4位。最大为1111，即10进制的15，代表IP报头的最大长度可以为15个32bits（4字节），也就是最长可为15*4=60字节，除去固定部分的长度20字节，可变部分的长度最大为40字节。

3. 服务类型 (1B, TOS)

4. 总长度   (2B)

  IP报文的总长度, 报头的长度和数据部分的长度之和


5. 标识     (2B)

  唯一的标识主机发送的每一分数据报。通常每发送一个报文，它的值加一。当IP报文长度超过传输网络的MTU（最大传输单元）时必须分片，这个标识字段的值被复制到所有数据分片的标识字段中，使得这些分片在达到最终目的地时可以依照标识字段的内容重新组成原先的数据。

6. 标志     (3位)

  共3位。R、DF、MF三位。目前只有后两位有效，DF位：为1表示不分片，为0表示分片。MF：为1表示“更多的片”，为0表示这是最后一片。

7. 片位移   (5位 + 1B)

  本分片在原先数据报文中相对首位的偏移位。（需要再乘以8）



8. 生存时间 (1B, TTL)

  IP报文所允许通过的路由器的最大数量。每经过一个路由器，TTL减1，当为0时，路由器将该数据报丢弃。TTL 字段是由发送端初始设置一个 8 bit字段.推荐的初始值由分配数字 RFC 指定，当前值为 64。发送 ICMP 回显应答时经常把 TTL 设为最大值 255。

9. 协议    (1B)

  指出IP报文携带的数据使用的是那种协议，以便目的主机的IP层能知道要将数据报上交到哪个进程（不同的协议有专门不同的进程处理）。和端口号类似，此处采用协议号，TCP的协议号为6，UDP的协议号为17。ICMP的协议号为1，IGMP的协议号为2.

10. 首部校验和 (2B)

  计算IP头部的校验和，检查IP报头的完整性。



11. 源IP地址   (4B)

  标识IP数据报的源端设备

12. 目的IP地址 (4B)

  标识IP数据报的目的地址


> IP报文

```
45 00 00 34 92 9B 40 00 40 06 90 90 0A 0B 01 B0 0A 0B
01 D3 23 2A 0F 36 59 8A CF 34 74 9E 4B 31 50 18 00 ED
73 96 00 00 00 00 00 0C 00 00 00 04 00 00 08 A6
---------- ---------- ---------- ----------
45 00 00 34
92 9B 40 00
40 06 90 90

0A 0B 01 B0
0A 0B 01 D3

23 2A 0F 36 59 8A CF 34 74 9E 4B 31 50 18 00 ED 73 96
00 00 00 00 00 0C 00 00 00 04 00 00 08 A6
```

45 00 00 34 -> 0x45=01000101, 0100 4 IPv4; 0101 (5*8=20) 首部长度20字节 (固定长度(20) + 可选字段长度(0)); 0x00 区分服务; 0x0034=52 总长度 (首部长度 + 数据内容长度)
92 9B 40 00 -> 
40 06 90 90 ->
0A 0B 01 B0 -> 0x0A0B01B0=10.11.1.176 (源IP地址)
0A 0B 01 D3 -> 0x0A0B01D3=10.11.1.211 (目的IP地址)



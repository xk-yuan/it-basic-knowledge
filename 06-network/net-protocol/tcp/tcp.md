# TCP

>

## 简介

![](https://img2018.cnblogs.com/i-beta/1806965/201911/1806965-20191129103945139-344813675.png)
![](https://images.cnblogs.com/cnblogs_com/buttercup/1825293/o_200810151025tcp_seg.png)
![](http://c.biancheng.net/uploads/allimg/191108/6-19110Q62344I5.gif)

TCP报头 (20B) = 源端口号(2B) + 目的端口号(2B)   + 序号(4B) + 确认号(4B)   + 首部长度(4位) + 保留(6位) + FLAG(6位, URG,ACK,PSH,RST,SYN,FIN) + 窗口大小(2B) + 校验和(2B) + 紧急指针(2B) 

TCP报文 = TCP报头 + 选项 + 数据

1. 源端口号 (2B)

2. 目的端口号 (2B)

3. 序号 (4B)

4. 确认号 (4B)


5. 首部长度 (4位)

  数据偏移，表示报文首部的长度，占4比特，表示数据开始的地方离TCP段的起始处有多远。实际上就是TCP段首部的长度。由于首部长度不固定，因此数据偏移字段是必要的。数据偏移以32位为长度单位，因此TCP首部的最大长度是60（15*4）个字节。

6. 保留 (6位)

7. FLAG(6位, URG,ACK,PSH,RSTmSYN,FIN)

URG (1位), 表示紧急指针字段是否有效

ACK (1位), 置位表示确认号字段有效; TCP协议规定，只有ACK=1时有效，也规定连接建立后所有发送的报文的ACK必须为1

PSH (1位), 长1位，表示当前报文需要请求推（push）操作

RST (1位), 长1位，置位表示复位TCP连接

SYN (1位), 在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文。对方若同意建立连接，则应在响应报文中使SYN=1和ACK=1. 因此,SYN置1就表示这是一个连接请求或连接接受报文。

FIN (1位), 用于释放TCP连接时标识发送方比特流结束；即完，终结的意思， 用来释放一个连接。当 FIN = 1时，表明此报文段的发送方的数据已经发送完毕，并要求释放连接。


8. 窗口大小 (2B)


9. 校验和(2B)

10. 紧急指针(2B) 


```
23 2A 0F 36 59 8A CF 34 74 9E 4B 31 50 18 00 ED 73 96
00 00 00 00 00 0C 00 00 00 04 00 00 08 A6

---------- ---------- ---------- ----------

23 2A 0F 36
59 8A CF 34
74 9E 4B 31
50 18 00 ED
73 96 00 00

00 00 00 0C 00 00 00 04 00 00 08 A6
```

23 2A 0F 36    ->   0x232A=9002 源端口号(2B); 0x0F36=3894 目的端口号(2B)
59 8A CF 34    ->   0x598ACF34=1502269236 序号
74 9E 4B 31    ->   0x749E4B31=1956530993 确认号

50 18 00 ED    ->   0x5018=0101 000000 011000, 0101=5 (5*(32/8)=20B, 首部长度); 011000= (FLAG: ACK,PSH); 0x00ED=237 (窗口大小)

73 96 00 00    ->   0x7396 校验和; 0x0000 紧急指针



32 14 00 06 74 6f 70 69 63 31 00 01 48 65 6c 6c 6f 20 4d 51 54 54

[ Fixed Header | Variable Header | Payload]

Fixed Header : 固定头部, 必须包含固定头

- 连接，发布，订阅，心跳

Variable Header : 可变头部

Payload : 消息载体, 内容

=====

首字节(字节1)和剩余消息报文长度(1-4字节)


固定头 = 首字节 (1B, MQTT Control Packet type, 确定报文类型) + 长度 (1-4字节)

7	    6	      5      	4	    3	    2	        1	                    0

MQTT	Control	Packet	type	Flags specific	to each	MQTT Control	Packet type


协议类型 (4位(bit7~bit4)表示协议类型)

0 0 1 1 0 0 1 0  = 0 , 

0 0 1 1 : 高4位(bit7~bit4)表示协议类型  16   - 0011 = 3 =>  => PUBLISH	3	Client <--> Server	发布消息

0 0 1 0 :  0010 = 2 --->  PUBREL	保留	0	0	1	0 

====

低4位(bit3~bit0)用来表示某些报文类型的控制字段


